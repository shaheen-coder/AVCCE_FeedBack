{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=person" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'js/env.js' %}"></script>
    <style>
        .chart-box {
            height: 200px;
        }

        body {
            height: 100vh;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <div class="max-w-7xl mx-auto p-6 space-y-6">

        <!-- Info Box -->
        <div class="bg-white rounded-xl shadow p-4 text-center text-lg font-semibold flex justify-between">
            <h1 class="flex items-center">
                <img class="w-10"
                    src="https://images.crunchbase.com/image/upload/c_pad,f_auto,q_auto:eco,dpr_1/g4fs8q57tzijze51i0iy"
                    alt=""> AVC ADMIN
            </h1>
            <div class="flex space-x-5 items-center">
                <a href="/staff/" class="hover:underline">Home</a>
                <a href="{% url 'admin:index' %}" class="hover:underline">Data Center</a>
                <button class="ring-2 ring-red-500 px-3 rounded-md text-red-500 hover:text-white hover:bg-red-500">Log
                    Out</button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-white rounded-xl shadow p-4 text-center text-lg font-semibold flex justify-around">
            <select id="semester" name=""
                class="px-5 ring-1 ring-gray-300 hover:bg-blue-100 rounded hover:scale-105 shadow-lg">
                <option value="">sem</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>
            <select id="section" name=""
                class="px-5 ring-1 ring-gray-300 hover:bg-blue-100 rounded hover:scale-105 shadow-lg">
                <option value="">Section</option>
                <option value="A">A</option>
                <option value="B">B</option>
            </select>

            <select id="batch" name=""
                class="px-5 ring-1 ring-gray-300 hover:bg-blue-100 rounded hover:scale-105 shadow-lg">
                <option value="">batch</option>
            </select>

            <button id="filter-button"
                class="px-5 ring-1 ring-gray-300 hover:bg-blue-100 rounded hover:scale-105 shadow-lg">filter</button>
        </div>

        <!-- Search Results -->
        <div class="max-w-7xl mx-auto p-6 space-y-6 bg-gray-200/50 rounded-lg" id="search-result"></div>

    </div>

    <script>
        // URLs and Mode
        const BATCH_UPDATE_URL = API_URL + 'staff/api/get/batch/';
        const SEARCH_URL = API_URL + 'api/student-search/';
        const btn = 'Report';

        // Task 1: Fetch batches and populate the batch dropdown
        fetch(BATCH_UPDATE_URL)
            .then(response => response.json())
            .then(data => {
                const batchSelect = document.getElementById("batch");
                // Note: Task says "batchs", but code uses "batch". Assuming "batch" based on consistency.
                const batches = data.batch || data.batches || []; // Fallback in case key is "batches"
                batches.forEach(item => {
                    batchSelect.innerHTML += `<option value="${item}">${item}</option>`;
                });
            })
            .catch(error => console.error('Error fetching batches:', error));

        // Task 2 & 3: Add event listener to filter button and handle API calls based on mode
        document.getElementById("filter-button").addEventListener("click", () => {
            // Get selected values
            const semester = document.getElementById("semester").value || null;
            const dept = "{{request.user.dept}}" || null;
            const batch = document.getElementById("batch").value || null;
            const sec = document.getElementById("section").value || null;

            let URL;
            let postData;

            // Construct POST data based on MODE
            URL = SEARCH_URL;
            postData = {
                name: null,
                dept: dept,
                sem: Number(semester),
                sec: sec,
                batch : batch
            };
            console.log(`data : ${JSON.stringify(postData)}`);
            // Send POST request
            fetch(URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(postData)
            })
                .then(response => response.json())
                .then(data => {
                    const searchResult = document.getElementById("search-result");
                    searchResult.innerHTML = "";
                    console.log("data:", data);

                    data.forEach(item => {
                        const { regno, name, dept } = item.student;
                        const { section, semester } = item;
                        const url = `/staff/report/student/${regno}/${batch}/`;

                        // build one card per student
                        searchResult.innerHTML += `
                            <div class="card flex items-center justify-between bg-white rounded-xl shadow p-4 text-center text-lg font-semibold group hover:bg-blue-400 mb-4">
                            <span class="material-symbols-outlined ring-2 ring-gray-500 group-hover:ring-gray-100 rounded-full p-2 group-hover:bg-blue-200">
                                person
                            </span>
                            <div class="text-left flex-1 px-4 space-y-1">
                                <p>Reg. No.: <span class="font-bold group-hover:text-white">${regno}</span></p>
                                <p>Name: <span class="font-bold group-hover:text-white">${name}</span></p>
                                <p>Dept.: <span class="font-bold group-hover:text-white">${dept}</span></p>
                                <p>Section: <span class="font-bold group-hover:text-white">${section}</span></p>
                                <p>Semester: <span class="font-bold group-hover:text-white">${semester}</span></p>
                            </div>
                            <a href="${url}"
                                class="text-blue-500 font-semibold ring-1 px-2 rounded-sm hover:bg-blue-500 group-hover:bg-blue-100 hover:shadow-md">
                                View Report
                            </a>
                            </div>
                        `;
                    });

                })
                .catch(error => console.error('Error fetching search results:', error));
        });
    </script>

</body>

</html>